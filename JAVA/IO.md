# 입출력 스트림

- 스트림 (Stream) :
  - 정의 :  데이터를 전달을 위한 가상 연결 통로
  - 스트림은 단방향통신만 가능하다. 즉, 입출력을 동시에 수행할 수 없다.
- 자바에서 데이터는 스트림을 통해 입출력 된다
  - 입력 스트림 : 키보드, 파일, 프로그램
  - 출력 스트림 : 모니터, 파일, 프로그램



</br>

## 1. 입출력 스트림의 종류

- java.io에서는 스트림 클래스 제공
  - byte 기반 스트림 : 그림, 멀티미디어 등 바이너리 데이터 I/O 에 사용
  - character 기반 스트림 : 문자 데이터를 읽고 출력할 때 사용
- 최상위 클래스로 byte, character 기반 스트림 구별 가능
  - byte 기반 스트림
    - InputStream
    - OutputStream
  - character 기반 스트림
    - Reader
    - Writer





## 2. 바이트 출력 스트림 (OutputStream)

- OutputStream은 추상 클래스로 바이트 기반 출력 스트림의 최상위 클래스
- 모든 바이트 기반 출력 스트림 클래스는 OutputStream 클래스를 상속받아 만들어짐
  - `FileOutputStream`, `PrintStream`, `ButteredOutputStream`, `DataOutputStream`

- OutputStream 클래스의 주요 메소드는 다음과 같다.

  - 출력 스트림은 출력할 바이트를 바로 내보내는 것이 아니라 내부 버퍼에 저장해놓고 한번에 출력한다.

  | 메서드                             | 설명                                                         |
  | :--------------------------------- | :----------------------------------------------------------- |
  | write(int b)                       | 1byte 출력                                                   |
  | write(byte[] b)                    | 매개값으로 주어진 배열 b의 모든 바이트 출력                  |
  | write(byte[ ] b, int off, int len) | 매개값으로 주어진 바이트 배열 b[off] 부터 len 개까지의 바이트 출력 |
  | flush()                            | 버퍼에 잔류하는 모든 바이트를 출력                           |
  | close()                            | 사용한 시스템 자원을 반납하고 출력 스트림 닫기               |



> #### 내부 버퍼를 사용하는 이유는 무엇일까?
>
> 내부 버퍼를 사용해 입/출력 횟수가 줄여 시스템 콜의 횟수가 줄인다.





## 3. 바이트 입력 스트림 (InputStream)

- InputStream은 추상 클래스로 바이트 기반 입력 스트림의 최상위 클래스
- 모든 바이트 기반 입력 스트림 클래스는 InputStream 클래스를 상속받아 만들어짐
  - `FileInputStream`,  `ButteredInputStream`, `DataInputStream`

- InputStream 클래스의 주요 메소드는 다음과 같다.

  | 메서드                           | 설명                                                         |
  | :------------------------------- | :----------------------------------------------------------- |
  | read()                           | 1byte를 읽고 이를 리턴                                       |
  | read(byte[] b)                   | 읽은 바이트를 매개값으로 주어진 배열에 저장하고 읽은 바이트 수를 리턴 |
  | read(byte[] b, int off, int len) | len 개의 바이트를 읽고 매개값으로 주어진 바이트 배열 b[off] 부터 len 개까지 저장. 읽은 바이트 수를 리턴 |
  | close()                          | 사용한 시스템 자원을 반납하고 입력 스트림 닫기               |





## 4. 성능 향상 보조 스트림

프로그램 실행 성능은 입출력이 가장 느린 장치를 따라간다. 예를 들어 CPU와 메모리가 빨라도 하드디스크의 입출력이 느려지면 프로그램 실행 성능은 하드 디스크의 처리 속도에 맞추어 진다.

따라서 __프로그램이 입출력 소스와 직접 작업하지 않고 중간에 메모리 버퍼와 작업함으로써__ 실행 성능을 향상시킬 수 있다. 예를 들어 프로그램이 직접 하드디스크에 데이터를 보내지 않고 메모리 버퍼에 데이터를 보내고, 메모리 버퍼에서 한번에 하드 디스크에 데이터를 보냄으로써 출력 횟수를 줄일 수 있는 것이다.

기본적으로 출력 스트림은 내부에 작은 버퍼를 가지고 있지만, 보조 스트림으로 메모리 버퍼를 추가로 제공하여 프로그램의 실행을 향상시킬 수 있다. 



#### (1) BufferedOutputStream, ButteredWrite

- 프로그램에서 전송한 데이터를 내부 버퍼에 쌓아 두었다가 버퍼가 꽉 차면 버퍼의 모든 데이터를 한꺼번에 보내는 출력 스트림. 프로그램 입장에서는 메모리 버퍼로 데이터를 고속 전송하기 때문에 출력 성능이 향상되는 효과를 얻게 된다.
  - BufferedOutputStream : 바이트 기반 출력 스트림에 연결되어 버퍼를 제공하는 보조 스트림
  - ButteredWrite : 문자 기반 출력 스트림에 연결되어 버퍼 제공하는 보조 스트림



#### (2) BufferedInputStream, ButteredReader

- 입력 소스로부터 자신의 내부 버퍼 크기만큼 데이터를 미리 읽고 버퍼에 저장해둔다. 프로그램은 외부의 입력 소스로부터 직접 읽는 대신 버퍼로부터 읽음으로써 읽기 성능을 향상한다.
  - BufferedInputStream : 바이트 기반 입력 스트림에 연결되어 버퍼를 제공하는 보조 스트림
  - ButteredReader : 문자 기반 압력 스트림에 연결되어 버퍼 제공하는 보조 스트림





## 5. 표준 스트림 (System.in, System.out, System.err)

- 표준 입출력 스트림은 java.lang 패키지의 System 클래스 내부에 static 으로 선언되어 있다.

  ```
  public final class System {
      public static final InputStream in;
      public static final PrintStream out;
      public static final PrintStream err;
      ....
  }                                                                                  
  ```

  - System.in : 콘솔로부터 데이터를 입력받을 때 사용
  - System.out : 콘솔에 데이터를 출력시 사용
  - System.err : 에러 출력
    - System.err도 출력 스트림이다. 단, err는 버퍼링을 지원하지 않는다. 버퍼링을 하던 도중 프로그램이 멈추면 버퍼링된 내용은 출력되지 않는다. 따라서 보다 정확하고 빠른 출력을 위해 System.err를 사용한다. 





## 6. NIO(New Input/Output)

- 자바 1.4 버전부터 추가된 API 

  |             | I/O                | NIO                       |
  | ----------- | ------------------ | ------------------------- |
  | 입출력 방식 | Stream             | Channe                    |
  | 버퍼        | 사용하지 않음      | 사용                      |
  | 블로킹 방식 | 블로킹 방식만 지원 | 블로킹/논블로킹 모두 지원 |



### (1) Stream vs Channel

- __Stream__ : 단방향 방식만 사용. 즉, 입력을 위해서는 입력 스트림이, 출력을 위해서는 출력 스트림이 필요.
- __Channel__ : 양방향 입출력 가능. 하나의 채널로 동시에 입, 출력 가능.



### (2) Buffer vs Non-Buffer

- I/O는 크기가 작은 내부 버퍼 외에 버퍼가 별도로 없다. 따라서 보조 스트림인 `BufferedInputStream`, `BufferedOutputStream`을 연결해 사용하기도 한다.

- NIO는 입출력시 버퍼를 자동으로 사용한다.



### (3) Blocking vs Non-Blocking

- __Blocking__ : 데이터 입/출력시 입력/출력이 될 때 까지 스레드가 대기상태(Blocking)를 유지하는 것
  - IO Thread가 블로킹되면 다른 일을 할 수 없고 블로킹을 빠져나오기 위해 인터럽트(interrupt)도 할 수 없다.
  - 블로킹을 빠져나오는 유일한 방법은 스트림을 닫는것이다.

- __Non-Blocking__ : 데이터 입/출력시 입력/출력이 바로 되지 않더라도 스레드가 대기상태를 유지하지 않는다.
  - **NIO 블로킹은 스레드가 인터럽트(interrupt) 함으로써 빠져나올 수 있다.**
  - NIO의 넌블로킹은 입출력 작업 준비가 완료된 채널만 선택해서 작업 Thread가 처리하기 때문에 작업 Thread가 블로킹되지 않는다.



#### <참고> 기존I/O프로세스와 커널 Buffer

![I:O](https://github.com/workhardslave/cs-study/blob/main/JAVA/img/I:O.png?raw=true)

- 유저 영역 : 실행 중인 프로그램이 존재하는 영역(하드웨어에 직접 접근 불가)

- 커널 영역 : 하드웨어에 직접 접근이 가능하고 다른 프로세스를 제어할 수 있는 영역

- 자바 I/O 프로세스

  **1) 프로세스가 커널에 파일 읽기 명령을 내림.**

  **2) 커널은 `시스템 콜[read()]`을 사용해 디스크 컨트롤러가 물리적 디스크로부터 읽어온 파일 데이터를 커널 영역안의 버퍼에 쓴다.**

  > **DMA(Direct Memory Access) : CPU의 도움없이 물리적 디스크에서 커널영역의 버퍼로 데이터를 읽어오는 것**

  **3) 모든 파일 데이터가 버퍼에 복사되면 다시 프로세스 안의 버퍼로 복사한다.**

  **4) 프로세스 안의 버퍼의 내용으로 프로그래밍한다.**

  

그러나 해당 IO 프로세는 3)의 과정이 비효율적이라는 문제점이 존재한다. 왜냐하면 커널안의 버퍼 데이터를 프로세스 안으로 다시 복사하기 때문이다.

그렇다면 만약 3)의 과정을 없애고 **커널영역에 바로 접근할 수 있다면 어떻게 될까? 만약 이게 가능하다면 버퍼를 복사하는 CPU를 낭비하지도 , GC관리를 따로 하지 않아도 I/O를 사용**할 수 있게 된다. 이를 위한 방법으로 커널 Buffer를 사용할 수 있다.



- 커널 버퍼 : 운영체제가 관리하는 메모리 영역에 생성되는 버퍼 공간
  - 자바는 외부데이터를 가져올때 **OS의 메모리 버퍼에 먼저 담았다가 JVM 내의 버퍼에 한번 더 옮겨**줘야 하기 때문에 시스템 메모리를 직접 다루는 C언어에 비해 입출력이 느리다.
  - **ByteBuffer** 클래스의 `allocateDirect()` 메소드를 사용하면 커널 버퍼를 사용할 수 있다. 그 외로 만들어지는 버퍼는 모두 JVM 내에 생성되는 버퍼이다.







> #### Reference
>
> https://www.notion.so/I-O-af9b3036338c43a8bf9fa6a521cda242
>
> https://bingbingpa.github.io/java/whiteship-live-study-week13/
>
> 혼자 공부하는 자바

